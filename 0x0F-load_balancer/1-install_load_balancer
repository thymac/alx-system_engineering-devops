#!/usr/bin/env bash
# Script to install and configure HAProxy on the load balancer server

# Update system packages
apt-get update

# Install HAProxy
apt-get install -y haproxy

# Configure HAProxy
CONFIG_FILE="/etc/haproxy/haproxy.cfg"

# Backup the original config file
cp "$CONFIG_FILE" "$CONFIG_FILE.bak"

# Define the load balancing configuration
LOAD_BALANCING_CONFIG=$(cat << EOL
frontend lb-frontend
    bind *:80
    mode http
    default_backend lb-backend

backend lb-backend
    balance roundrobin
    server web-01 54.174.79.165:80 check
    server web-02 34.201.174.169:80 check
EOL
)

# Check if the load balancing configuration already exists in the file
if ! grep -q "frontend lb-frontend" "$CONFIG_FILE"; then
    # Remove the default configuration
    sed -i '/^frontend/s/^/#/' "$CONFIG_FILE"
    sed -i '/^backend/s/^/#/' "$CONFIG_FILE"

    # Append the load balancing configuration
    echo "$LOAD_BALANCING_CONFIG" >> "$CONFIG_FILE"
fi

# Restart HAProxy service
service haproxy restart

